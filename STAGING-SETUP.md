# üöß –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Staging –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –û–±–∑–æ—Ä
Staging –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ –∏ production, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–¥–¥–æ–º–µ–Ω: `staging.room-gpt.ru`
- –û—Ç–¥–µ–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- –û—Ç–¥–µ–ª—å–Ω—ã–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–æ—Ä—Ç–∞—Ö
- –ó–∞—â–∏—Ç—É –æ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞–º–∏

---

## 1Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS

–î–æ–±–∞–≤—å—Ç–µ A-–∑–∞–ø–∏—Å—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞:
```
A  staging  <IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞>
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞:
```bash
nslookup staging.room-gpt.ru
```

---

## 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
```bash
ssh root@<IP —Å–µ—Ä–≤–µ—Ä–∞>
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```bash
cd /root/roomai-redesign  # –∏–ª–∏ –≤–∞—à –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
git pull origin main
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ç–∫—É staging (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
git checkout -b staging
git push -u origin staging
```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx –¥–ª—è staging
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥
cp nginx-staging.conf /etc/nginx/sites-available/staging.room-gpt.ru

# –°–æ–∑–¥–∞–π—Ç–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
ln -s /etc/nginx/sites-available/staging.room-gpt.ru /etc/nginx/sites-enabled/

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
nginx -t
```

### –®–∞–≥ 5: –ü–æ–ª—É—á–∏—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
```bash
certbot --nginx -d staging.room-gpt.ru
```

### –®–∞–≥ 6: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx
```bash
systemctl reload nginx
```

---

## 3Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.staging` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```bash
nano .env.staging
```

–î–æ–±–∞–≤—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø—Ä–∏–º–µ—Ä):
```env
# Database
DATABASE_URL=postgresql://postgres:your_password@postgres-staging:5432/roomgpt_staging

# NextAuth
NEXTAUTH_URL=https://staging.room-gpt.ru
NEXTAUTH_SECRET=your_different_secret_key_for_staging

# OAuth (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
GOOGLE_CLIENT_ID=your_staging_google_client_id
GOOGLE_CLIENT_SECRET=your_staging_google_client_secret

# API Keys
REPLICATE_API_KEY=your_replicate_api_key

# Environment
NODE_ENV=staging
```

**–í–∞–∂–Ω–æ:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è staging, –¥–æ–±–∞–≤–∏–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π redirect URL:
- `https://staging.room-gpt.ru/api/auth/callback/google`

---

## 4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ Staging –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –®–∞–≥ 1: –î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è
```bash
chmod +x deploy-staging.sh
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ staging –æ–∫—Ä—É–∂–µ–Ω–∏–µ
```bash
./deploy-staging.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã staging
- –ü–æ–¥—Ç—è–Ω–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git
- –°–æ–±–µ—Ä—ë—Ç –Ω–æ–≤—ã–µ Docker –æ–±—Ä–∞–∑—ã
- –ó–∞–ø—É—Å—Ç–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã staging

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```bash
docker-compose -f docker-compose.staging.yml ps
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã:
- `roomgpt-staging` (Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ä—Ç—É 3001)
- `postgres-staging` (PostgreSQL –Ω–∞ –ø–æ—Ä—Ç—É 5433)

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
```bash
# –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker-compose -f docker-compose.staging.yml logs -f app

# –õ–æ–≥–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
docker-compose -f docker-compose.staging.yml logs -f db
```

---

## 5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```
https://staging.room-gpt.ru
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
- ‚úÖ –ë–∞–Ω–Ω–µ—Ä –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã: "üöß –¢–ï–°–¢–û–í–ê–Ø –í–ï–†–°–ò–Ø"
- ‚úÖ –í title –±—Ä–∞—É–∑–µ—Ä–∞: "üöß STAGING - RoomGPT"

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞—â–∏—Ç—É –æ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
–û—Ç–∫—Ä–æ–π—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Ctrl+U) –∏ –Ω–∞–π–¥–∏—Ç–µ:
```html
<meta name="robots" content="noindex, nofollow">
```

---

## 6Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Staging

–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è staging –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
./deploy-staging.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
git pull origin staging
docker-compose -f docker-compose.staging.yml down
docker-compose -f docker-compose.staging.yml build --no-cache
docker-compose -f docker-compose.staging.yml up -d
```

---

## 7Ô∏è‚É£ –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å staging
```bash
docker-compose -f docker-compose.staging.yml down
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å staging
```bash
docker-compose -f docker-compose.staging.yml restart
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
```bash
docker-compose -f docker-compose.staging.yml logs -f
```

### –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
```bash
docker-compose -f docker-compose.staging.yml exec app sh
```

### –û—á–∏—Å—Ç–∏—Ç—å volumes (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –ë–î)
```bash
docker-compose -f docker-compose.staging.yml down -v
```

---

## 8Ô∏è‚É£ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "502 Bad Gateway"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä app –∑–∞–ø—É—â–µ–Ω:
```bash
docker-compose -f docker-compose.staging.yml ps
docker-compose -f docker-compose.staging.yml logs app
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Cannot connect to database"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é DATABASE_URL –≤ .env.staging:
```bash
docker-compose -f docker-compose.staging.yml exec app env | grep DATABASE_URL
```

### –ü—Ä–æ–±–ª–µ–º–∞: SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ certbot:
```bash
certbot renew --nginx
systemctl reload nginx
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è Google
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è NODE_ENV=staging –∏–ª–∏ NEXTAUTH_URL —Å–æ–¥–µ—Ä–∂–∏—Ç "staging"

---

## 9Ô∏è‚É£ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Nginx (–ø–æ—Ä—Ç 80/443)           ‚îÇ
‚îÇ  staging.room-gpt.ru ‚Üí localhost:3001   ‚îÇ
‚îÇ  room-gpt.ru ‚Üí localhost:3000           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Production          ‚îÇ  Staging             ‚îÇ
‚îÇ  localhost:3000      ‚îÇ  localhost:3001      ‚îÇ
‚îÇ  ‚Üì                   ‚îÇ  ‚Üì                   ‚îÇ
‚îÇ  PostgreSQL:5432     ‚îÇ  PostgreSQL:5433     ‚îÇ
‚îÇ  (roomgpt)           ‚îÇ  (roomgpt_staging)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] DNS A-–∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è staging.room-gpt.ru
- [ ] Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
- [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ certbot
- [ ] –§–∞–π–ª .env.staging —Å–æ–∑–¥–∞–Ω —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- [ ] OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è staging URL
- [ ] Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã staging –∑–∞–ø—É—â–µ–Ω—ã
- [ ] Staging —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ https://staging.room-gpt.ru
- [ ] –ë–∞–Ω–Ω–µ—Ä "–¢–ï–°–¢–û–í–ê–Ø –í–ï–†–°–ò–Ø" –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] Meta tag robots="noindex,nofollow" –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- [ ] –û—Ç–¥–µ–ª—å–Ω–∞—è –ë–î staging —Ä–∞–±–æ—Ç–∞–µ—Ç

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –í–∞—à–µ staging –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.

