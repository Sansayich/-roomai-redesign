#!/bin/bash

# RoomAI - Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ (Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ!)

set -e

echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ñ GitHub..."
cd /opt/roomai

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
git clone https://github.com/Sansayich/-roomai-redesign.git .

echo ""
echo "âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½!"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
cat > .env << 'EOF'
# REPLICATE API TOKEN - Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð• ÐÐ Ð¡Ð’ÐžÐ™!
REPLICATE_API_TOKEN=r8_Ð²Ð°Ñˆ_Ñ‚Ð¾ÐºÐµÐ½_Ð·Ð´ÐµÑÑŒ

# NEXTAUTH SECRET - ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
NEXTAUTH_SECRET=$(openssl rand -base64 32)

# URL ÑÐµÑ€Ð²ÐµÑ€Ð° - Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð• ÐÐ Ð’ÐÐ¨ IP!
NEXTAUTH_URL=http://Ð²Ð°Ñˆ-ip-Ð°Ð´Ñ€ÐµÑ

# Google OAuth (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
EOF

echo ""
echo "âš ï¸  Ð’ÐÐ–ÐÐž! ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð»:"
echo ""
echo "nano /opt/roomai/.env"
echo ""
echo "Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ:"
echo "1. REPLICATE_API_TOKEN - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð½Ð° https://replicate.com/account/api-tokens"
echo "2. NEXTAUTH_URL - ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ IP Ð²Ð°ÑˆÐµÐ³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°"
echo ""
echo "ÐŸÐ¾ÑÐ»Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ: Ctrl+X, Ð·Ð°Ñ‚ÐµÐ¼ Y, Ð·Ð°Ñ‚ÐµÐ¼ Enter"
echo ""
read -p "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ .env..."

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
echo ""
echo "ðŸŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx..."
cat > /etc/nginx/sites-available/roomai << 'NGINX_EOF'
server {
    listen 80;
    server_name _;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    client_max_body_size 10M;
}
NGINX_EOF

ln -sf /etc/nginx/sites-available/roomai /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t && systemctl restart nginx

echo "âœ… Nginx Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!"
echo ""

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall
echo "ðŸ”¥ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall..."
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
echo "y" | ufw enable

echo ""
echo "ðŸ³ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°..."
cd /opt/roomai
docker-compose build
docker-compose up -d

echo ""
echo "======================================"
echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "======================================"
echo ""
echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°:"
docker-compose ps
echo ""
echo "ðŸŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð½Ð°:"
echo "   http://$(curl -s ifconfig.me)"
echo ""
echo "ðŸ“ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²:"
echo "   docker-compose logs -f"
echo ""

